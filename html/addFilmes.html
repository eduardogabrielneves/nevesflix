<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Catálogo de Filmes</title>
  <link rel="stylesheet" href="../styles/addFilmes.css">
  <link rel="icon" type="image/png" href="imagens/favicon.png" />
</head>
<body>

  <nav class="navbar">
    <a href="filmes.html" class="logo"><img src="../styles/imagens/logobranca.png" alt="Logo" /></a>
    <ul class="nav-menu" style="margin-right: 50px;">
      <li id="navUsuarios"><a href="usuarios.html">Cadastro de Usúarios</a></li>
      <li id="navUsuarios"><a href="addFilmes.html">Cadastro de Filmes</a></li>
    </ul>
  </nav>

  <h1>Filmes Cadastrados</h1>

  <section id="admin-filmes">
    <form id="formFilme">
      <label for="titulo">Nome do Filme:</label>
      <input type="text" id="titulo" name="titulo" required />

      <label for="imagem">URL da Imagem (capa):</label>
      <input type="url" id="imagem" name="imagem" required />

      <button type="submit" id="btnSalvarFilme">Adicionar Filme</button>
      <button type="button" id="btnCancelarFilme" style="display:none;">Cancelar Edição</button>
    </form>

    <ul id="listaFilmes"></ul>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/pouchdb@7.3.1/dist/pouchdb.min.js"></script>
  <script>
    const dbFilmes = new PouchDB('movies');
    let filmeEditando = null;

    const formFilme = document.getElementById('formFilme');
    const btnSalvarFilme = document.getElementById('btnSalvarFilme');
    const btnCancelarFilme = document.getElementById('btnCancelarFilme');
    const listaFilmes = document.getElementById('listaFilmes');

    formFilme.addEventListener('submit', async e => {
      e.preventDefault();

      const filmeData = {
        titulo: formFilme.titulo.value.trim(),
        imagem: formFilme.imagem.value.trim(),
      };

      if (!filmeData.titulo || !filmeData.imagem) {
        alert('Por favor, preencha todos os campos!');
        return;
      }

      try {
        if (filmeEditando) {
          filmeData._id = filmeEditando._id;
          filmeData._rev = filmeEditando._rev;
          await dbFilmes.put(filmeData);
          alert('Filme atualizado com sucesso!');
          filmeEditando = null;
          btnSalvarFilme.textContent = 'Adicionar Filme';
          btnCancelarFilme.style.display = 'none';
        } else {
          filmeData._id = 'filme_' + Date.now();
          await dbFilmes.put(filmeData);
          alert('Filme adicionado com sucesso!');
        }
        formFilme.reset();
        carregarFilmes();
      } catch (err) {
        alert('Erro ao salvar filme: ' + err.message);
        console.error(err);
      }
    });

    btnCancelarFilme.addEventListener('click', () => {
      filmeEditando = null;
      formFilme.reset();
      btnSalvarFilme.textContent = 'Adicionar Filme';
      btnCancelarFilme.style.display = 'none';
    });

    async function carregarFilmes() {
      listaFilmes.innerHTML = '';
      try {
        const result = await dbFilmes.allDocs({ include_docs: true });
        result.rows.forEach(row => {
          const f = row.doc;
          if (!f._id.startsWith('filme_')) return;

          const li = document.createElement('li');

          const spanTitulo = document.createElement('span');
          spanTitulo.textContent = f.titulo;

          const btnEditar = document.createElement('button');
          btnEditar.textContent = 'Editar';
          btnEditar.addEventListener('click', () => {
            filmeEditando = f;
            preencherFormulario(f);
            btnSalvarFilme.textContent = 'Salvar Alterações';
            btnCancelarFilme.style.display = 'inline-block';
          });

          const btnExcluir = document.createElement('button');
          btnExcluir.textContent = 'Excluir';
          btnExcluir.addEventListener('click', async ev => {
            ev.stopPropagation();
            if (confirm(`Deseja excluir o filme "${f.titulo}"?`)) {
              try {
                await dbFilmes.remove(f);
                alert('Filme excluído com sucesso!');
                if (filmeEditando && filmeEditando._id === f._id) {
                  filmeEditando = null;
                  formFilme.reset();
                  btnSalvarFilme.textContent = 'Adicionar Filme';
                  btnCancelarFilme.style.display = 'none';
                }
                carregarFilmes();
              } catch (error) {
                alert('Erro ao excluir filme: ' + error.message);
              }
            }
          });

          const btnContainer = document.createElement('div');
          btnContainer.appendChild(btnEditar);
          btnContainer.appendChild(btnExcluir);

          li.appendChild(spanTitulo);
          li.appendChild(btnContainer);

          listaFilmes.appendChild(li);
        });
      } catch (err) {
        console.error('Erro ao carregar filmes:', err);
      }
    }

    function preencherFormulario(filme) {
      formFilme.titulo.value = filme.titulo || '';
      formFilme.imagem.value = filme.imagem || '';
    }

    window.addEventListener('load', carregarFilmes);
  </script>

</body>
</html>
