<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Catálogo de Filmes</title>
  <link rel="stylesheet" href="../styles/addFilmes.css" />
  <link rel="icon" type="image/png" href="imagens/favicon.png" />
  <script src="https://cdn.jsdelivr.net/npm/pouchdb@7.3.1/dist/pouchdb.min.js"></script>
  <script src="../scripts/script.js"></script>
</head>
<body>
  <nav class="navbar">
    <a href="filmes.html"><img src="../styles/imagens/logobranca.png" alt="Logo" /></a>
    <ul class="nav-menu">
      <li id="navUsuarios"><a href="usuarios.html">Administrador</a></li>
    </ul>
    <input type="text" id="searchInput" placeholder="Pesquisar filmes..." onkeyup="filterMovies()" />
  </nav>

  <div id="section1">
    <div>
      <h1 id="titulo">Destaques da semana...</h1>
    </div>
    <div class="movies-container">
      <!-- Aqui ficam seus cards de filmes estáticos, pode manter ou depois substituir pela lista dinâmica -->
    </div>
  </div>

  <!-- Seção administrativa de filmes -->
  <section id="admin-filmes">
    <h2>Adicionar / Editar Filme</h2>
    <form id="formFilme">
      <label>Nome do Filme:</label><br />
      <input type="text" name="titulo" required /><br />

      <label>URL da Imagem (capa):</label><br />
      <input type="url" name="imagem" required /><br />

      <button type="submit" id="btnSalvarFilme">Adicionar Filme</button>
      <button type="button" id="btnCancelarFilme" style="display:none; margin-left: 10px;">Cancelar Edição</button>
    </form>

    <h3>Filmes Cadastrados</h3>
    <ul id="listaFilmes"></ul>
  </section>

  <script>
    const dbFilmes = new PouchDB('movies');
    let filmeEditando = null;

    const formFilme = document.getElementById('formFilme');
    const btnSalvarFilme = document.getElementById('btnSalvarFilme');
    const btnCancelarFilme = document.getElementById('btnCancelarFilme');
    const listaFilmes = document.getElementById('listaFilmes');

    formFilme.addEventListener('submit', async e => {
      e.preventDefault();

      const filmeData = {
        titulo: formFilme.titulo.value.trim(),
        imagem: formFilme.imagem.value.trim(),
      };

      try {
        if (filmeEditando) {
          filmeData._id = filmeEditando._id;
          filmeData._rev = filmeEditando._rev;
          await dbFilmes.put(filmeData);
          alert('Filme atualizado com sucesso!');
          filmeEditando = null;
          btnSalvarFilme.textContent = 'Adicionar Filme';
          btnCancelarFilme.style.display = 'none';
        } else {
          filmeData._id = 'filme_' + Date.now();
          await dbFilmes.put(filmeData);
          alert('Filme adicionado com sucesso!');
        }
        formFilme.reset();
        carregarFilmes();
      } catch (err) {
        alert('Erro ao salvar filme: ' + err.message);
        console.error(err);
      }
    });

    btnCancelarFilme.addEventListener('click', () => {
      filmeEditando = null;
      formFilme.reset();
      btnSalvarFilme.textContent = 'Adicionar Filme';
      btnCancelarFilme.style.display = 'none';
    });

    async function carregarFilmes() {
      listaFilmes.innerHTML = '';
      try {
        const result = await dbFilmes.allDocs({ include_docs: true });
        result.rows.forEach(row => {
          const f = row.doc;
          if (!f._id.startsWith('filme_')) return;

          const li = document.createElement('li');

          const spanTitulo = document.createElement('span');
          spanTitulo.textContent = `${f.titulo}`;

          const btnEditar = document.createElement('button');
          btnEditar.textContent = 'Editar';
          btnEditar.addEventListener('click', () => {
            filmeEditando = f;
            preencherFormulario(f);
            btnSalvarFilme.textContent = 'Salvar Alterações';
            btnCancelarFilme.style.display = 'inline-block';
          });

          const btnExcluir = document.createElement('button');
          btnExcluir.textContent = 'Excluir';
          btnExcluir.addEventListener('click', async ev => {
            ev.stopPropagation();
            if (confirm(`Deseja excluir o filme "${f.titulo}"?`)) {
              try {
                await dbFilmes.remove(f);
                alert('Filme excluído com sucesso!');
                if (filmeEditando && filmeEditando._id === f._id) {
                  filmeEditando = null;
                  formFilme.reset();
                  btnSalvarFilme.textContent = 'Adicionar Filme';
                  btnCancelarFilme.style.display = 'none';
                }
                carregarFilmes();
              } catch (error) {
                alert('Erro ao excluir filme: ' + error.message);
              }
            }
          });

          li.appendChild(spanTitulo);
          li.appendChild(btnEditar);
          li.appendChild(btnExcluir);
          listaFilmes.appendChild(li);
        });
      } catch (err) {
        console.error('Erro ao carregar filmes:', err);
      }
    }

    function preencherFormulario(filme) {
      formFilme.titulo.value = filme.titulo || '';
      formFilme.imagem.value = filme.imagem || '';
    }

    // Função para pesquisa - opcional, se quiser filtrar a lista de filmes cadastrados
    function filterMovies() {
      const filter = document.getElementById('searchInput').value.toLowerCase();
      const items = listaFilmes.getElementsByTagName('li');
      for (let i = 0; i < items.length; i++) {
        const text = items[i].textContent.toLowerCase();
        items[i].style.display = text.indexOf(filter) > -1 ? '' : 'none';
      }
    }

    window.addEventListener('load', () => {
      carregarFilmes();
      // Pode chamar filterMovies() se quiser filtrar ao carregar
    });
  </script>
</body>
</html>
